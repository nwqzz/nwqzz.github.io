
<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="./css/default.css">
    <link rel="stylesheet" href="./css/tools.css">
  </head>
  <body>

    <header class="topnav">
	    <a href="./index.html">Home</a>
      <a class="active" href="./tools.html">Tools</a>
      <a href="./code_snippets.html">Code Snippets</a>
      <a href="./about.html">About</a>
	  </header>

    <div class="sidenav">
      <ul>
        <li><a class="active" href="#timer">Timer</a></li>
        <li><a href="#todo">todo</a></li>
        <li><a href="#todo">todo</a></li>
        <li><a href="#todo">todo</a></li>
      </ul>
    </div>

    <div class="main">

      <div class="split left">

        <h4>Enter a time or timespan</h4>

        <div>
          <div class="timer" >
            <span id=timer1>
              <input type="text" id="timerInput1" value="1 minute 10 seconds">
              <button onclick="start(1)"> start </button>
            </span>
          <span id="resetFrame"></span>
          </div>
        </span>

        <div class="progressBar" id="progressBar1">
        </div>

        <h4>or specify a time and date.</h4>

        <div class="timer">
          <span id=timer2>
            <input type="datetime-local" id='timerInput2' value=now>
            <button onclick="start(2)"> start </button>
          </span>
        </div>

        <div class="progressBar" id="progressBar2">
        </div>

        <div class="split right">
          <p>description</p>
        </div>
      </div>
    </div>

    <script>

      // add timer Object make all statuses and methods object dependent
      
      let running = false;
      let isReset = false;

      function start(timer) {
      
        running = true;
        
        // display reset button
        let resetButton = '<button onclick="reset()" style=\'float: right;\'> reset </button>';
        document.getElementById('resetFrame').innerHTML =  resetButton;

        // read the relevant input field
        let input = document.getElementById("timerInput"+timer).value;

        let timeSpan = parse(input); 
        let startTime = new Date();
        let endTime = new Date(startTime.getTime()+timeSpan) ;

        let x = setInterval(function(){

          if(!running){
            clearInterval(x);
          }
          if(isReset){
            
            resetHtml = '<input type="text" id="timerInput1" value="1 minute 10 seconds"><button onclick="start()"> start </button>';
            document.getElementById("timer"+timer).innerHTML = resetHtml;
            document.getElementById("progressBar"+timer).style.width = 0;
            running = false;
            isReset = false;
            return;
          }

          let now = new Date();
          let countDown = endTime - now;

          let timerEnded = false;
          if(countDown<0){
            timerEnded = true;
            countDown *= -1;
          }

          let seconds = Math.floor((countDown % (1000 * 60)) / 1000);
          let minutes = Math.floor((countDown % (1000 * 60 * 60)) / (1000 * 60));
          let hours = Math.floor((countDown % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          let days = Math.floor(countDown / (1000 * 60 * 60 * 24));

          let countDownText = '';



          // check and only output days hours and minutes if applicable
          if(days){
            countDownText += days + ' days ';
            countDownText += hours + ' hours ';
            countDownText += minutes + ' minutes ';
          }else{
            if(hours){
            countDownText += hours + ' hours ';
            countDownText += minutes + ' minutes ';
            }else{
              if(minutes){
                countDownText += minutes + ' minutes ';
              }
            }
          }
          countDownText += seconds + ' seconds ';

          // changed output if timer has run out
          if(timerEnded){
            document.getElementById("timer"+timer).innerHTML = 'Timer ended '+countDownText+' ago! ';
            return;
          }

          document.getElementById("timer"+timer).innerHTML = (countDownText);

          // calculate and set the progress bar width
          let progressBarWidth = ((now.getTime() - startTime.getTime())/(timeSpan)*100).toFixed(2)+ "%"
          document.getElementById("progressBar"+timer).style.width = progressBarWidth;
        
        }, 10);
      }

      function reset(){
        running = false;
        isReset = true;
      }

      // converts text from the input field into a timespan, using regex
      function parse(input){

        
        console.log(input)
        // check if input is in default format (from date picker)
        if(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(input)){
          // return distance between chosen time and now in milliseconds
          return new Date(input) - new Date();
        }

        // remove all whitespace
        input = input.replace(/\s/g,'');

        // test if input only contains numbers
        if(/^\d+$/.test(input)){

          //interpret input as minutes
          return input * 60000;
        }
        
        let until = false;  // specifies whether the timer runs until a specified time (true) or for a specified timespan (false)
        
        // check for keywords that imply a specified endtime
        let keyWords = ['at', 'until', 'um', 'bis', 'am', 'pm', 'Uhr', 'uhr'];
        keyWords.forEach(element => {
          if(input.startsWith(element)||input.endsWith(element)){
            until = true;
          }
        });

        let pm = false; // pm specifies whether the time is in the afternoon, i.e. +12 hours
        if(input.endsWith('pm')){
            pm = true;
        }
        
        keyWords.forEach(element => {
          input = input.replace(element, '');
        });

        // test if input format is '(hh:)mm:ss'
        if(/^(\d+:)?\d{1,2}:\d{1,2}$/.test(input)){
          
          let split = input.split(':');

          // treat the entered string as an endtime and calculate the timespan from now to then
          if(until){
            
            // filling in seconds value with 0 if it is not set
            if(!split[2]){
              split[2] = 0;
            }

            let timeOfDay = convertTimespan(split); // the number of milliseconds between the entered time and 00:00 am
            
            let todaysDate = new Date();            // the time and date at 00:00 am today
            todaysDate.setHours(0,0,0,0);
            
            let endTime = new Date();               // a Date object with todays date and the time from the input field 
            endTime.setTime(todaysDate.getTime()+timeOfDay);
            
            // add 12 hours is the time is 'pm'
            if(pm){
              endTime.setHours(endTime.getHours()+12);
            }
            
            // if the time entered is already in the past, adjust endtime to the following day
            if(endTime - new Date()<0){
              endTime.setDate(endTime.getDate()+1)
            }
            
            // return the distance between the specified end time and now
            return endTime - new Date();
          }

          return convertTimespan(split);
        }

        // test if input is formated with hours, minutes, seconds, h, m, s or equivalent
        //    (h  hours          mm     minutes             ss     seconds)
        if(/^(\d+(h|hour(s)?))?(\d{1,2}(m|min|minute(s)?))?(\d{1,2}(s|sec|second(s)?))?$/.test(input)){
          
          split = parseWordInput(input);
          return convertTimespan(split);
        }
      }

      // takes string input in the form of hh hours mm minutes ss seconds
      function parseWordInput(input){

          //the following code checks whether hours minutes or seconds are used and prepares the split array for timespan conversion
          let hasHours = false;
          let hasMinutes = false;
          let hasSeconds = false;

          if(/(h|hour(s)?)/.test(input)){
            hasHours = true;
            input = input.replace(/(hour(s)?|h)/,':');
          }

          if(/(m|min|minute(s)?)/.test(input)){
            hasMinutes = true;
            input = input.replace(/(minute(s)?|min|m)/,':');
          }
          
          if(/(s|sec|second(s)?)/.test(input)){
            hasSeconds = true;
            input = input.replace(/(second(s)?|sec|s)/,'');
          }
          
          let split = input.split(':');
          if(hasHours && !hasMinutes && hasSeconds){
            split[2]= split[1];
            split[1] = '00';
          }else{

          }
          if(!hasSeconds){
            split[2] = 00;
          }

          return split;
      }

      // receives an array containing (hours) (minutes) seconds; return timespan in milliseconds
      function convertTimespan(split){
        
        split.reverse();
        
        let secs = Number(split[0]);
        
        let mins = 0;
        if(split[1]){
          mins = Number(split[1]);
        }
        let hours = 0;
        if(split[2]){
          hours = Number(split[2]);
        }
        
        return (hours * 3600 + mins*60 + secs) * 1000;

      }

      function convertDateTime(input, pm){
        
        console.log(input);
        let endtime = new Date();

        
        start.setHours(split);


      }

    </script>

  </body>
</html>
